<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ò–ò –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –∫–∏–Ω–æ ‚Äî MVP</title>
  <!-- Tailwind (CDN, –±–µ–∑ —Å–±–æ—Ä–∫–∏) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React / ReactDOM UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel –¥–ª—è on-the-fly –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ JSX (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ–º–æ/—Å—Ç–∞—Ç–∏—á–Ω–æ–≥–æ —Ö–æ—Å—Ç–∏–Ω–≥–∞) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-black">
  <div id="root"></div>

  <script type="text/babel">
    // ‚¨áÔ∏è –í–°–¢–ê–í–¨ –°–Æ–î–ê –ö–û–î –ö–û–ú–ü–û–ù–ï–ù–¢–ê –ò–ó CANVAS (–Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ –º–µ–Ω—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ)

export default function InteractiveCinemaMVP() {
  // --- App State ---
  const DEFAULT_LOOP_SECONDS = 480; // 8 minutes = 480s
  const [loopSeconds, setLoopSeconds] = React.useState(DEFAULT_LOOP_SECONDS);
  const [timeLeft, setTimeLeft] = React.useState(loopSeconds);
  const [loopCount, setLoopCount] = React.useState(1);
  const [sceneId, setSceneId] = React.useState("start");
  const [history, setHistory] = React.useState([]);
  const [clues, setClues] = React.useState([]);
  const [toast, setToast] = React.useState("");
  const [fastMode, setFastMode] = React.useState(false);
  const [muted, setMuted] = React.useState(true);
  const [sceneImages, setSceneImages] = React.useState({}); // sceneId -> dataURL or URL
  const [autoGen, setAutoGen] = React.useState(true);
  const [genStyle, setGenStyle] = React.useState("storyboard");
  const fileRef = React.useRef(null);
  const [freeAction, setFreeAction] = React.useState("");

  // --- Assistant Image Gen (no external API) ---
  const [gptStyle, setGptStyle] = React.useState('realistic');
  const [assistModal, setAssistModal] = React.useState(false);
  const [assistProgress, setAssistProgress] = React.useState('ready');
  const [assistantAsk, setAssistantAsk] = React.useState('');
  const pollRef = React.useRef(null);

  // New: manual paste/drop modal when clipboard is blocked
  const [pasteModal, setPasteModal] = React.useState(false);
  const pasteBoxRef = React.useRef(null);

  // --- Lightweight tests state ---
  const [testReport, setTestReport] = React.useState(null);

  // --- Scenes Engine ---
  const SCENES = React.useMemo(() => ({
    start: {
      title: "–°–¶–ï–ù–ê 1 ‚Äî –ü–†–û–ë–£–ñ–î–ï–ù–ò–ï (T-08:00)",
      text: `–í—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ –≥–ª–∞–∑–∞. –ú–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–π –≥—É–ª –ø–æ–µ–∑–¥–∞. –¢–µ—Å–Ω—ã–π —Ç—É–∞–ª–µ—Ç, –∑–∞–ø–æ—Ç–µ–≤—à–µ–µ –∑–µ—Ä–∫–∞–ª–æ.
–í –æ—Ç—Ä–∞–∂–µ–Ω–∏–∏ ‚Äî —á—É–∂–æ–µ –ª–∏—Ü–æ. –í –∫–∞—Ä–º–∞–Ω–µ ‚Äî –±–∏–ª–µ—Ç: –ú–∞—Ä–∫ –°—Ç—Ä–æ—Å—Å, –∏–Ω–∂–µ–Ω–µ—Ä.
–í —É—Ö–µ –ø–æ—Ç—Ä–µ—Å–∫–∏–≤–∞–µ—Ç –≥–æ–ª–æ—Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: ¬´–ö–∞–ø–∏—Ç–∞–Ω –ö–æ—É–ª—Ç–µ—Ä, –≤—ã –≤ —Å–∏–º—É–ª—è—Ü–∏–∏. –£ –≤–∞—Å 8 –º–∏–Ω—É—Ç –¥–æ –≤–∑—Ä—ã–≤–∞. –ù–∞–π–¥–∏—Ç–µ –±–æ–º–±—É¬ª.`,
      prompt: `35yo man in a cramped train restroom mirror, shocked expression, fogged glass, stainless walls, faint motion blur from moving train; cold blue, high contrast; cyberpunk-noir; cinematic, shallow depth of field`,
      choices: [
        { id: 1, label: "–û—Å–º–æ—Ç—Ä–µ—Ç—å —Å—É–º–∫—É", next: "bag" },
        { id: 2, label: "–í—ã–π—Ç–∏ –≤ –∫–æ—Ä–∏–¥–æ—Ä", next: "corridor" },
        { id: 3, label: "–ü–æ–∑–≤–æ–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä—É", next: "call" },
      ],
    },
    bag: {
      title: "–°–¶–ï–ù–ê ‚Äî –°–£–ú–ö–ê",
      text: `–í–Ω—É—Ç—Ä–∏ ‚Äî –±—É–º–∞–∂–Ω–∏–∫, –æ–¥–Ω–æ—Ä–∞–∑–æ—á–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω, –ø—Ä–æ–µ–∑–¥–Ω–æ–π, —Å–∞–ª—Ñ–µ—Ç–∫–∏. –ü–æ–¥–∫–ª–∞–¥–∫–∞ —Ä–∞—Å–ø–æ—Ä–æ—Ç–∞ –∏ –∑–∞–Ω–æ–≤–æ –ø—Ä–æ—à–∏—Ç–∞.
–ù–∞ —Ç–∫–∞–Ω–∏ ‚Äî —Å–ª–µ–¥—ã –≥—Ä–∞—Ñ–∏—Ç–∞. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ö—Ä–æ–Ω.`,
      onEnter: () => addClueSafe("–°–ª–µ–¥—ã –≥—Ä–∞—Ñ–∏—Ç–∞ –≤ –ø–æ–¥–∫–ª–∞–¥–∫–µ"),
      prompt: `open messenger bag with improvised lining stitches, tiny graphite smudges, forensic macro, cyber-noir lighting`,
      choices: [
        { id: 1, label: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª–∞–¥–∫—É –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ", next: "lining" },
        { id: 2, label: "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–æ—Ä–∏–¥–æ—Ä", next: "corridor" },
        { id: 3, label: "–ù–∞–±—Ä–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞", next: "call" },
      ],
    },
    lining: {
      title: "–°–¶–ï–ù–ê ‚Äî –ü–û–î–ö–õ–ê–î–ö–ê",
      text: `–í—ã –Ω–∞—â—É–ø—ã–≤–∞–µ—Ç–µ —Ç–æ–Ω–∫—É—é –ø–ª–∞—Å—Ç–∏–Ω—É ‚Äî SIM-–∫–∞—Ä—Ç–∞ —Å –æ–±–ª–æ–º–∞–Ω–Ω—ã–º —É–≥–æ–ª–∫–æ–º –∏ –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º. –ö—Ç–æ-—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ—ë –∫–∞–∫ –¥–µ—Ç–æ–Ω–∞—Ç–æ—Ä –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–º –∫–∞–Ω–∞–ª–µ.`,
      onEnter: () => addClueSafe("SIM-–ø–ª–∞—Ç–∞ —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º (–≤–æ–∑–º–æ–∂–Ω—ã–π –¥–µ—Ç–æ–Ω–∞—Ç–æ—Ä)"),
      prompt: `macro shot of sim card with microcontroller add-on, improvised electronics, cinematic close-up, blue steel palette`,
      choices: [
        { id: 1, label: "–°–ª–æ–º–∞—Ç—å –ø–ª–∞—Ç—É", next: "fail_hint" },
        { id: 2, label: "–°–ø—Ä—è—Ç–∞—Ç—å –∏ –∏–¥—Ç–∏ –≤ –∫–æ—Ä–∏–¥–æ—Ä", next: "corridor" },
        { id: 3, label: "–°–æ–µ–¥–∏–Ω–∏—Ç—å —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º", next: "call" },
      ],
    },
    corridor: {
      title: "–°–¶–ï–ù–ê 2 ‚Äî –ö–û–†–ò–î–û–† (T-07:25)",
      text: `–£–∑–∫–∏–π –ø—Ä–æ—Ö–æ–¥, –ø–∞—Å—Å–∞–∂–∏—Ä—ã, –∑–∞–ø–∞—Ö –∫–æ—Ñ–µ. –í–ø–µ—Ä–µ–¥–∏ ‚Äî —á–µ–ª–æ–≤–µ–∫ –≤ —á—ë—Ä–Ω–æ–º —Å –∂—ë—Å—Ç–∫–∏–º –∫–µ–π—Å–æ–º. –û–Ω –∏–¥—ë—Ç –±—ã—Å—Ç—Ä–æ –∏ –æ–≥–ª—è–¥—ã–≤–∞–µ—Ç—Å—è. –í —Ö–≤–æ—Å—Ç–µ –≤–∞–≥–æ–Ω–∞ ‚Äî –ø—Ä–æ–≤–æ–¥–Ω–∏–∫. –í—Ä–µ–º—è —É—Ç–µ–∫–∞–µ—Ç.`,
      prompt: `narrow moving train aisle, man in black coat carrying a hard case, passengers blurred, cyberpunk-noir, cool blue, cinematic`,
      choices: [
        { id: 1, label: "–ü—Ä–æ—Å–ª–µ–¥–∏—Ç—å –Ω–µ–∑–∞–º–µ—Ç–Ω–æ", next: "tail" },
        { id: 2, label: "–†–µ–∑–∫–æ –æ–±–æ–≥–Ω–∞—Ç—å –∏ —Ç–æ–ª–∫–Ω—É—Ç—å –ø–ª–µ—á–æ–º", next: "bump" },
        { id: 3, label: "–°—Ä–µ–∑–∞—Ç—å –∫ –≤–∞–≥–æ–Ω—É 3", next: "car3_prep" },
      ],
    },
    tail: {
      title: "–°–¶–ï–ù–ê ‚Äî –•–í–û–°–¢",
      text: `–í—ã –¥–µ—Ä–∂–∏—Ç–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é. –ù–∞ –∫–µ–π—Å–µ ‚Äî –º–µ–ª–∫–∞—è –Ω–∞–∫–ª–µ–π–∫–∞: ¬´Li-ion¬ª. –ü–∞–ª—å—Ü—ã —É –Ω–µ–≥–æ –≤ —á—ë—Ä–Ω–æ–π –ø—ã–ª–∏ ‚Äî –≥—Ä–∞—Ñ–∏—Ç?`,
      onEnter: () => addClueSafe("–ö–µ–π—Å —Å Li-ion, –ø–∞–ª—å—Ü—ã –≤ –≥—Ä–∞—Ñ–∏—Ç–µ —É –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ"),
      prompt: `hard case with tiny li-ion warning sticker, suspect hand with graphite dust, shallow depth of field, tense tracking shot`,
      choices: [
        { id: 1, label: "–ü–æ–∑–≤–∞—Ç—å –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–µ–π—Å", next: "conductor" },
        { id: 2, label: "–°–ª–µ–¥–æ–≤–∞—Ç—å –¥–æ –≤–∞–≥–æ–Ω–∞ 3", next: "car3_meet" },
        { id: 3, label: "–ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å –∫–ª—é—á–æ–º –∏–∑ —Å—É–º–∫–∏", next: "lock_try" },
      ],
    },
    bump: {
      title: "–°–¶–ï–ù–ê ‚Äî –°–¢–û–õ–ö–ù–û–í–ï–ù–ò–ï",
      text: `–í—ã –∑–∞–¥–µ–≤–∞–µ—Ç–µ –µ–≥–æ –ø–ª–µ—á–æ–º. –ö–µ–π—Å –Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–∏–µ –ø—Ä–∏–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è ‚Äî –≤–Ω—É—Ç—Ä–∏ –±–∞—Ç–∞—Ä–µ–∏ –∏ –º–∞–ª–µ–Ω—å–∫–∞—è –ø–ª–∞—Ç–∞ —Å –∞–Ω—Ç–µ–Ω–∫–æ–π. –û–Ω –∫–ª–∞—Ü–∞–µ—Ç –∑–∞–º–∫–æ–º –∏ —à–∏–ø–∏—Ç: ¬´–°–º–æ—Ç—Ä–∏ –ø–æ–¥ –Ω–æ–≥–∏¬ª.`,
      onEnter: () => addClueSafe("–í–Ω—É—Ç—Ä–∏ –∫–µ–π—Å–∞: –±–∞—Ç–∞—Ä–µ–∏ + –ø–ª–∞—Ç–∞ —Å –∞–Ω—Ç–µ–Ω–Ω–æ–π"),
      prompt: `hard case briefly open revealing batteries and tiny radio board, dynamic motion, tense moment, cinematic still`,
      choices: [
        { id: 1, label: "–û—Ç—Å—Ç—É–ø–∏—Ç—å –∏ –ø—Ä–æ—Å–ª–µ–¥–∏—Ç—å –¥–∞–ª—å—à–µ", next: "car3_meet" },
        { id: 2, label: "–°—Ö–≤–∞—Ç–∏—Ç—å –∫–µ–π—Å –∏ –±–µ–∂–∞—Ç—å –∫ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫—É", next: "conductor" },
        { id: 3, label: "–£–π—Ç–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥ ‚Äî –ø–µ—Ä–µ—Ö–≤–∞—Ç –≤ –≤–∞–≥–æ–Ω–µ 3", next: "car3_prep" },
      ],
    },
    conductor: {
      title: "–°–¶–ï–ù–ê ‚Äî –ü–†–û–í–û–î–ù–ò–ö",
      text: `–ü—Ä–æ–≤–æ–¥–Ω–∏–∫ —Å–Ω–∞—á–∞–ª–∞ –Ω–µ –≤–µ—Ä–∏—Ç. –ù–æ, —É–≤–∏–¥–µ–≤ –Ω–∞–∫–ª–µ–π–∫—É –∏ –≤–∞—à–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã, —Å–æ–≥–ª–∞—à–∞–µ—Ç—Å—è –ø–æ–º–æ—á—å. –û–Ω –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å–≤—è–∑—å.`,
      onEnter: () => addClueSafe("–ü—Ä–æ–≤–æ–¥–Ω–∏–∫ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å, –¥–æ—Å—Ç—É–ø –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–≤—è–∑–∏"),
      prompt: `train conductor worried, intercom handset, emergency protocol vibes, cinematic`,
      choices: [
        { id: 1, label: "–¢—Ä–µ–±–æ–≤–∞—Ç—å —ç–∫—Å—Ç—Ä–µ–Ω–Ω—É—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É", next: "fail_stop" },
        { id: 2, label: "–ü–æ–ø—Ä–æ—Å–∏—Ç—å –æ–±—ä—è–≤–∏—Ç—å –∫–æ–¥-—Å–ª–æ–≤–æ –¥–ª—è —ç–≤–∞–∫—É–∞—Ü–∏–∏ –≤–∞–≥–æ–Ω–∞ 3", next: "car3_clear" },
        { id: 3, label: "–ü–æ–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ç–µ—Ö. —à–∫–∞—Ñ—É (–≥–ª—É—à–∏–ª–∫–∞)", next: "jammer" },
      ],
    },
    car3_prep: {
      title: "–°–¶–ï–ù–ê ‚Äî –ü–ï–†–ï–•–û–î –ö –í–ê–ì–û–ù–£ 3",
      text: `–í—ã –æ–ø–µ—Ä–µ–∂–∞–µ—Ç–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ. –í —Ç–∞–º–±—É—Ä–µ ‚Äî —Ç–µ—Ö. —à–∫–∞—Ñ. –í—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ —Å–ª–∞–±—ã–π —Ñ–æ–Ω —Ä–∞–¥–∏–æ—Å–∏–≥–Ω–∞–ª–∞.`,
      prompt: `narrow vestibule between train cars, technical cabinet, faint radio signal indicator, cyber-noir`,
      choices: [
        { id: 1, label: "–û—Ç–∫—Ä—ã—Ç—å —Ç–µ—Ö. —à–∫–∞—Ñ", next: "jammer" },
        { id: 2, label: "–°–ø—Ä—è—Ç–∞—Ç—å—Å—è –∏ –∂–¥–∞—Ç—å –µ–≥–æ", next: "car3_meet" },
        { id: 3, label: "–°–≤—è–∑–∞—Ç—å—Å—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º", next: "call" },
      ],
    },
    jammer: {
      title: "–°–¶–ï–ù–ê ‚Äî –ì–õ–£–®–ò–õ–ö–ê",
      text: `–í–Ω—É—Ç—Ä–∏ ‚Äî –∞–≤–∞—Ä–∏–π–Ω—ã–π –±–ª–æ–∫ —Å —Ñ—É–Ω–∫—Ü–∏–µ–π –≥–ª—É—à–µ–Ω–∏—è —Å–≤—è–∑–∏ (–¥–ª—è —Ç–µ—Å—Ç–æ–≤ —Å–µ—Ç–∏). –ï–≥–æ –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ 2 –º–∏–Ω—É—Ç—ã.`,
      onEnter: () => addClueSafe("–ì–ª—É—à–∏–ª–∫–∞ –Ω–∞ 2 –º–∏–Ω—É—Ç—ã –≤ —Ç–µ—Ö. —à–∫–∞—Ñ—É"),
      prompt: `emergency comms test box with simple switch, minimal UI, glowing indicator, macro cinematic`,
      choices: [
        { id: 1, label: "–í–∫–ª—é—á–∏—Ç—å –≥–ª—É—à–µ–Ω–∏–µ (2 –º–∏–Ω)", next: "jammer_on" },
        { id: 2, label: "–ù–µ —Ç—Ä–æ–≥–∞—Ç—å –∏ –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ", next: "car3_meet" },
        { id: 3, label: "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫—É", next: "conductor" },
      ],
    },
    jammer_on: {
      title: "–°–¶–ï–ù–ê ‚Äî –ì–õ–£–®–ï–ù–ò–ï –ê–ö–¢–ò–í–ù–û",
      text: `–í—ã –≤–∫–ª—é—á–∞–µ—Ç–µ –≥–ª—É—à–µ–Ω–∏–µ. –†–∞–¥–∏–æ–∫–∞–Ω–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ 120 —Å–µ–∫—É–Ω–¥. –≠—Ç–æ–≥–æ —Ö–≤–∞—Ç–∏—Ç, —á—Ç–æ–±—ã –∏–∑—ä—è—Ç—å –¥–µ—Ç–æ–Ω–∞—Ç–æ—Ä.`,
      onEnter: () => addClueSafe("–ì–ª—É—à–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ ‚Äî –æ–∫–Ω–æ 120—Å"),
      prompt: `close-up of toggle switch flipped, small timer display reading 120s, cinematic tension`,
      choices: [
        { id: 1, label: "–ò–¥—Ç–∏ –≤ –≤–∞–≥–æ–Ω 3 –∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å", next: "car3_meet" },
        { id: 2, label: "–ü–æ–∑–≤–∞—Ç—å –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–∞ –¥–ª—è —ç–≤–∞–∫—É–∞—Ü–∏–∏", next: "car3_clear" },
        { id: 3, label: "–°–≤—è–∑–∞—Ç—å—Å—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º", next: "call" },
      ],
    },
    car3_meet: {
      title: "–°–¶–ï–ù–ê ‚Äî –í–ê–ì–û–ù 3: –°–¢–û–õ–ö–ù–û–í–ï–ù–ò–ï",
      text: `–ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–π –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —Å —á–µ–ª–æ–≤–µ–∫–æ–º –≤ —Å–µ—Ä–æ–º. –û–Ω–∏ –º–µ–Ω—è—é—Ç—Å—è –æ–±—ä–µ–∫—Ç–∞–º–∏: –∫–µ–π—Å ‚Üî SIM-–ø–ª–∞—Ç–∞. –í–∞—à —à–∞–Ω—Å –≤–º–µ—à–∞—Ç—å—Å—è.`,
      prompt: `two men exchanging hard case and tiny sim board in train car, tense standoff, cinematic`,
      choices: [
        { id: 1, label: "–°—Ö–≤–∞—Ç–∏—Ç—å SIM-–ø–ª–∞—Ç—É –∏ —Ä–∞–∑–æ—Ä–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ", next: "success" },
        { id: 2, label: "–í—ã—Å—Ç—Ä–µ–ª–∏—Ç—å –∏–∑ –∞–≤–∞—Ä–∏–π–Ω–æ–≥–æ –ø–∏—Å—Ç–æ–ª–µ—Ç–∞ (–ø—Ä–æ–≤–∞–ª)", next: "fail_noise" },
        { id: 3, label: "–û—Ç—á–∞—è–Ω–Ω–æ –Ω–∞–∂–∞—Ç—å —Å—Ç–æ–ø-–∫—Ä–∞–Ω", next: "fail_stop" },
      ],
    },
    car3_clear: {
      title: "–°–¶–ï–ù–ê ‚Äî –í–ê–ì–û–ù 3 –û–ß–ò–©–ï–ù",
      text: `–û–±—ä—è–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç: –ø–∞—Å—Å–∞–∂–∏—Ä—ã –ø–µ—Ä–µ—Ö–æ–¥—è—Ç –≤ —Å–æ—Å–µ–¥–Ω–∏–µ –≤–∞–≥–æ–Ω—ã. –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ.`,
      prompt: `empty train car, seats, evacuation announcement echo, cinematic still`,
      choices: [
        { id: 1, label: "–ü–æ–¥–∫–∞—Ä–∞—É–ª–∏—Ç—å –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ —É –≤—Ö–æ–¥–∞", next: "car3_meet" },
        { id: 2, label: "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞—Ä—Ä–∏–∫–∞–¥—É –∏–∑ —Å–∏–¥–µ–Ω–∏–π", next: "fail_noise" },
        { id: 3, label: "–í–∫–ª—é—á–∏—Ç—å –≥–ª—É—à–∏–ª–∫—É –∏ –∂–¥–∞—Ç—å", next: "jammer_on" },
      ],
    },
    lock_try: {
      title: "–°–¶–ï–ù–ê ‚Äî –ó–ê–ú–û–ö",
      text: `–í–∞—à –∫–ª—é—á –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç. –ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–π –∑–∞–º–µ—á–∞–µ—Ç –ø–æ–ø—ã—Ç–∫—É –∏ —É—Å–∫–æ—Ä—è–µ—Ç—Å—è. –í—Ä–µ–º—è —Ç–µ—Ä—è–µ—Ç—Å—è.`,
      prompt: `close-up failed key attempt on hard case lock, brief eye contact with suspect, cinematic`,
      choices: [
        { id: 1, label: "–ü—Ä–æ—Å–ª–µ–¥–æ–≤–∞—Ç—å –≤ –≤–∞–≥–æ–Ω 3", next: "car3_meet" },
        { id: 2, label: "–û—Ç—Å—Ç—É–ø–∏—Ç—å –∫ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫—É", next: "conductor" },
        { id: 3, label: "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤–∑–ª–æ–º–∞—Ç—å ‚Äî —Ä–∏—Å–∫ (–ø—Ä–æ–≤–∞–ª)", next: "fail_noise" },
      ],
    },
    call: {
      title: "–°–¶–ï–ù–ê ‚Äî –°–í–Ø–ó–¨ –° –û–ü–ï–†–ê–¢–û–†–û–ú",
      text: `¬´–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –ø–µ—Ç–ª—é –Ω–∞ 8 –º–∏–Ω—É—Ç. –î–µ—Ä–∂–∏—Ç–µ –Ω–∏–∑–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å. –õ—é–±–∞—è –ø–∞–Ω–∏–∫–∞ —É—Å–∫–æ—Ä—è–µ—Ç –ø—Ä–æ–≤–∞–ª¬ª. –®—ë–ø–æ—Ç–æ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä –¥–∞—ë—Ç –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ: ¬´–ú–∞—è–∫-12¬ª.`,
      onEnter: () => addClueSafe("–ö–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: –ú–∞—è–∫-12"),
      prompt: `close-up of small earpiece/comm, mission control voice implied, moody cinematic`,
      choices: [
        { id: 1, label: "–°–∫–∞–∑–∞—Ç—å –∫–æ–¥ —Å–ª–æ–≤–æ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫—É", next: "conductor" },
        { id: 2, label: "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–æ—Ä–∏–¥–æ—Ä—É", next: "corridor" },
        { id: 3, label: "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –æ –≤—ã—Ö–æ–¥–µ –∏–∑ —Å–∏–º—É–ª—è—Ü–∏–∏ (—Ç–∞–π–Ω–∞—è)", next: "secret" },
      ],
    },
    // Endings
    success: {
      title: "–§–ò–ù–ê–õ ‚Äî –£–°–ü–ï–•",
      text: `–í—ã —É—Å–ø–µ–≤–∞–µ—Ç–µ –≤—ã—Ä–≤–∞—Ç—å SIM-–ø–ª–∞—Ç—É –∏ –ø–µ—Ä–µ–ª–æ–º–∏—Ç—å –¥–æ—Ä–æ–∂–∫–∏. –†–∞–¥–∏–æ–∫–∞–Ω–∞–ª –ø—É—Å—Ç. –ö–µ–π—Å –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –±–µ–∑–æ–±–∏–¥–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–∞—Ç–∞—Ä–µ–π. –ü–∞—Å—Å–∞–∂–∏—Ä—ã —Å–ø–∞—Å–µ–Ω—ã.
–û–ø–µ—Ä–∞—Ç–æ—Ä: ¬´–ß–∏—Å—Ç–∞—è —Ä–∞–±–æ—Ç–∞, –∫–∞–ø–∏—Ç–∞–Ω. –ü–µ—Ç–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞¬ª.`,
      prompt: `hero disables improvised detonator, relieved passengers in background, cinematic climax`,
      ending: "success",
      choices: [
        { id: 1, label: "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å –Ω–∞—á–∞–ª–∞", next: "restart" },
        { id: 2, label: "–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∂—É—Ä–Ω–∞–ª", next: "export" },
        { id: 3, label: "–û—Å—Ç–∞—Ç—å—Å—è –∏ –ø–µ—Ä–µ—á–∏—Ç–∞—Ç—å", next: "stay" },
      ],
    },
    fail_stop: {
      title: "–§–ò–ù–ê–õ ‚Äî –ü–†–û–í–ê–õ (–°–¢–û–ü-–ö–†–ê–ù)",
      text: `–†–µ–∑–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫—Ä–µ–Ω–∏–µ –∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –∑–∞–º—ã–∫–∞–Ω–∏–µ. –î–µ—Ç–æ–Ω–∞—Ç–æ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ. –¢—å–º–∞. –ü–µ—Ç–ª—è –Ω–∞—á–∏–Ω–∞–µ—Ç –∑–∞–Ω–æ–≤–æ.`,
      prompt: `red emergency brake handle pulled, sparks, abrupt chaos, cinematic`,
      ending: "fail",
      choices: [
        { id: 1, label: "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–µ—Ç–ª–∏", next: "restart" },
        { id: 2, label: "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –ø—É—Ç—å", next: "start" },
        { id: 3, label: "–≠–∫—Å–ø–æ—Ä—Ç –∂—É—Ä–Ω–∞–ª–∞", next: "export" },
      ],
    },
    fail_noise: {
      title: "–§–ò–ù–ê–õ ‚Äî –ü–†–û–í–ê–õ (–®–£–ú)",
      text: `–ì—Ä–æ–º–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏–≤–ª–µ–∫–∞—é—Ç –æ—Ö—Ä–∞–Ω—É. –ü–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–µ —É—Ö–æ–¥—è—Ç –≤ —Ç–æ–ª–ø–µ. –¢–∞–π–º–µ—Ä –¥–æ—Ö–æ–¥–∏—Ç –¥–æ –Ω—É–ª—è. –í—Å–ø—ã—à–∫–∞. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫.`,
      prompt: `blinding flash in train car, chaos blur, cinematic`,
      ending: "fail",
      choices: [
        { id: 1, label: "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–µ—Ç–ª–∏", next: "restart" },
        { id: 2, label: "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–∞—á–∞–ª—É", next: "start" },
        { id: 3, label: "–≠–∫—Å–ø–æ—Ä—Ç –∂—É—Ä–Ω–∞–ª–∞", next: "export" },
      ],
    },
    fail_hint: {
      title: "–§–ò–ù–ê–õ ‚Äî –ü–†–û–í–ê–õ (–ù–ï–û–°–¢–û–†–û–ñ–ù–û)",
      text: `–í—ã –ª–æ–º–∞–µ—Ç–µ –ø–ª–∞—Ç—É ‚Äî –æ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–º–ø—É–ª—å—Å –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–∞–Ω–∞–ª. –î–µ—Ç–æ–Ω–∞—Ü–∏—è. –í—ã –ø–æ–Ω–∏–º–∞–µ—Ç–µ –æ—à–∏–±–∫—É, –Ω–æ —É–∂–µ –ø–æ–∑–¥–Ω–æ.`,
      prompt: `tiny circuit snapped, sudden spark, cinematic`,
      ending: "fail",
      choices: [
        { id: 1, label: "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–µ—Ç–ª–∏", next: "restart" },
        { id: 2, label: "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–∞—á–∞–ª—É", next: "start" },
        { id: 3, label: "–≠–∫—Å–ø–æ—Ä—Ç –∂—É—Ä–Ω–∞–ª–∞", next: "export" },
      ],
    },
    secret: {
      title: "–¢–ê–ô–ù–ê–Ø –ö–û–ù–¶–û–í–ö–ê",
      text: `–í—ã —à–µ–ø—á–µ—Ç–µ: ¬´–ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã—Ö–æ–¥: –ú–∞—è–∫-12¬ª. –ù–∞ –¥–æ–ª—é —Å–µ–∫—É–Ω–¥—ã –≤—Å—ë –≥–∞—Å–Ω–µ—Ç. –í—ã –≤–∏–¥–∏—Ç–µ —Å–≤–æ—é –∫–∞–ø—Å—É–ª—É, –¥–∞—Ç—á–∏–∫–∏, –∑–µ–ª—ë–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ñ–ò–ó–ù–¨. –ó–∞—Ç–µ–º ‚Äî –º–∏–≥, –∏ —Å—Ü–µ–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è. –û–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–ª—á–∏—Ç, –Ω–æ –≤—ã –∑–Ω–∞–µ—Ç–µ: –ø—Ä–µ–¥–µ–ª—ã –µ—Å—Ç—å.`,
      prompt: `dim lab pod, cables, monitors, brief awakening, cinematic surreal`,
      ending: "secret",
      choices: [
        { id: 1, label: "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ç–ª—é", next: "restart" },
        { id: 2, label: "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–∞—á–∞–ª—É", next: "start" },
        { id: 3, label: "–≠–∫—Å–ø–æ—Ä—Ç –∂—É—Ä–Ω–∞–ª–∞", next: "export" },
      ],
    },
  }), []);

  // --- Helpers ---
  function addClueSafe(clue) {
    setClues((prev) => (prev.includes(clue) ? prev : [...prev, clue]));
  }

  function addHistory(entry) {
    setHistory((h) => [
      ...h,
      {
        t: new Date().toISOString(),
        loop: loopCount,
        scene: sceneId,
        action: entry,
      },
    ]);
  }

  // Write-to-clipboard with robust fallback (fix for NotAllowedError)
  async function safeWriteClipboard(text) {
    try {
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
        return true;
      }
    } catch (e) {
      // swallow and try fallback
    }
    try {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.setAttribute('readonly', '');
      ta.style.position = 'fixed';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return !!ok;
    } catch (e) {
      return false;
    }
  }

  async function copyPrompt() {
    const s = SCENES[sceneId]?.prompt || "";
    if (!s) return;
    const ok = await safeWriteClipboard(s);
    showToast(ok ? "SD-–ø—Ä–æ–º–ø—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω" : "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ‚Äî —Ç–µ–∫—Å—Ç –≤—ã–¥–µ–ª–µ–Ω –Ω–∏–∂–µ");
  }

  function exportLog() {
    const payload = {
      exportedAt: new Date().toISOString(),
      loopSeconds,
      loops: loopCount,
      history,
      clues,
      sceneImages,
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `interactive-cinema-log-loop${loopCount}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function showToast(msg) {
    setToast(msg);
    setTimeout(() => setToast(""), 2000);
  }

  // --- –°–≤–æ–±–æ–¥–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ---
  function guessNextFromFree(text) {
    const q = (text || "").toLowerCase();
    if (/—Å—É–º–∫|bag/.test(q)) return "bag";
    if (/–ø–æ–¥–∫–ª–∞–¥|sim|—Å–∏–º|–∫–∞—Ä—Ç–∞/.test(q)) return "lining";
    if (/–∫–æ—Ä–∏–¥|–ø—Ä–æ—Ö–æ–¥|–≤–ø–µ—Ä|corridor|aisle/.test(q)) return "corridor";
    if (/–ø—Ä–æ–≤–æ–¥–Ω–∏–∫|–∫–æ–Ω–¥—É–∫—Ç–æ—Ä|conductor/.test(q)) return "conductor";
    if (/–≥–ª—É—à–∏–ª|jam/.test(q)) return "jammer";
    if (/–≤–∞–≥–æ–Ω\s*3|car\s*3|–≤—Å—Ç—Ä–µ—á/.test(q)) return "car3_meet";
    if (/—ç–≤–∞–∫|–æ—á–∏—â/.test(q)) return "car3_clear";
    if (/—Å—Ç–æ–ø|–∫—Ä–∞–Ω|stop/.test(q)) return "fail_stop"; // FIXED earlier
    if (/—Å–µ–∫—Ä–µ—Ç|–≤—ã—Ö–æ–¥|–∫–∞–ø—Å—É–ª|secret/.test(q)) return "secret";
    if (/—Å–ª–µ–¥|—Ö–≤–æ—Å—Ç|tail|–ø—Ä–æ—Å–ª–µ–¥/.test(q)) return "tail";
    if (/—Å—Ç–æ–ª–∫|—Ç–æ–ª–∫–Ω|bump/.test(q)) return "bump";
    if (/–∑–∞–º–æ–∫|–∫–ª—é—á|lock/.test(q)) return "lock_try";
    if (/–∑–≤–æ–Ω|—Å–≤—è–∑|–æ–ø–µ—Ä–∞—Ç–æ—Ä|call/.test(q)) return "call";
    return (SCENES[sceneId]?.choices?.[0]?.next) || "corridor";
  }
  function runFreeAction() {
    const txt = freeAction.trim();
    if (!txt) return;
    addHistory(`–°–≤–æ–±–æ–¥–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: "${txt}"`);
    const next = guessNextFromFree(txt);
    setFreeAction("");
    go(next);
  }

  // --- Assistant image generation (no API) ---
  function buildPrompt(id){
    const s = SCENES[id] || {};
    const base = s.prompt || '';
    const cinematic = gptStyle === 'realistic'
      ? 'highly detailed, realistic people and props, cinematic lighting, 3:2, train interior'
      : 'stylized storyboard frame, clean lines, expressive characters, 3:2, train interior';
    return `${base}, ${cinematic}`.trim();
  }

  function buildAssistantAsk(id){
    const scene = SCENES[id] || {};
    const prompt = buildPrompt(id);
    return `–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–∏–Ω–æ.\n–°—Ü–µ–Ω–∞: ${scene.title}.\n–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: ${scene.text.split('\n')[0]}.\n–ü—Ä–æ–º–ø—Ç: ${prompt}.\n–†–∞–∑–º–µ—Ä: 1200x675px (3:2). –í–µ—Ä–Ω–∏ –∫–∞–∫ PNG.`;
  }

  async function copyRequestForAssistant(id){
    const ask = buildAssistantAsk(id);
    setAssistantAsk(ask);
    const ok = await safeWriteClipboard(ask);
    if (ok) {
      showToast('–ó–∞–ø—Ä–æ—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä ‚Äî –≤—Å—Ç–∞–≤—å—Ç–µ –≤ —á–∞—Ç');
    } else {
      showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ‚Äî –≤—ã–¥–µ–ª–∏—Ç–µ –∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C');
      setAssistModal(true); // –ø–æ–∫–∞–∂–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
      setAssistProgress('copied');
    }
  }

  // Helpers to read image/text from paste/drop events
  function readFileToScene(file){
    const reader = new FileReader();
    reader.onload = () => {
      setSceneImages((m) => ({ ...m, [sceneId]: reader.result }));
      showToast('–ö–∞–¥—Ä –¥–æ–±–∞–≤–ª–µ–Ω');
    };
    reader.readAsDataURL(file);
  }

  function handlePasteEvent(e){
    const dt = e.clipboardData;
    if (!dt) return;
    // images first
    if (dt.items && dt.items.length){
      for (const it of dt.items){
        if (it.type && it.type.startsWith('image/')){
          const file = it.getAsFile();
          if (file){ readFileToScene(file); e.preventDefault(); return; }
        }
      }
    }
    const text = dt.getData && dt.getData('text/plain');
    if (text && (/^data:image\//i.test(text) || /^https?:/i.test(text))){
      setSceneImages(m => ({ ...m, [sceneId]: text }));
      showToast('–ö–∞–¥—Ä –≤—Å—Ç–∞–≤–ª–µ–Ω –∏–∑ —Ç–µ–∫—Å—Ç–∞ –±—É—Ñ–µ—Ä–∞');
      e.preventDefault();
      return;
    }
  }

  function handleDropEvent(e){
    e.preventDefault();
    if (e.dataTransfer?.files?.length){
      const file = e.dataTransfer.files[0];
      if (file && /^image\//i.test(file.type)){
        readFileToScene(file);
      }
    }
  }

  async function pasteImageFromClipboard(){
    try{
      if (navigator.clipboard && navigator.clipboard.read) {
        const items = await navigator.clipboard.read();
        for (const item of items){
          const type = item.types.find(t => t.startsWith('image/'));
          if (type){
            const blob = await item.getType(type);
            const reader = new FileReader();
            reader.onload = () => { setSceneImages(m => ({ ...m, [sceneId]: reader.result })); showToast('–ö–∞–¥—Ä –≤—Å—Ç–∞–≤–ª–µ–Ω –∏–∑ –±—É—Ñ–µ—Ä–∞'); };
            reader.readAsDataURL(blob);
            return true;
          }
        }
      }
      // fallback: try read text (data URL or http)
      const text = await navigator.clipboard.readText();
      if (/^data:image\//i.test(text) || /^https?:/i.test(text)){
        setSceneImages(m => ({ ...m, [sceneId]: text }));
        showToast('–ö–∞–¥—Ä –≤—Å—Ç–∞–≤–ª–µ–Ω –∏–∑ —Ç–µ–∫—Å—Ç–∞ –±—É—Ñ–µ—Ä–∞');
        return true;
      }
      showToast('–ë—É—Ñ–µ—Ä –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
      return false;
    }catch{ 
      // Permissions Policy blocks programmatic clipboard access. Show manual modal.
      setPasteModal(true);
      showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –±—É—Ñ–µ—Ä—É ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Ctrl+V/Drag&Drop');
      return false; 
    }
  }

  // --- Assistant flow: one-click generate via assistant and auto-import ---
  async function checkClipboardOnceSilent(){
    try{
      if (navigator.clipboard && navigator.clipboard.read) {
        const items = await navigator.clipboard.read();
        for (const item of items){
          const type = item.types.find(t => t.startsWith('image/'));
          if (type){
            const blob = await item.getType(type);
            const reader = new FileReader();
            return await new Promise(res=>{ reader.onload=()=>{ setSceneImages(m=>({...m,[sceneId]:reader.result})); res(true); }; reader.readAsDataURL(blob); });
          }
        }
      }
      const text = await navigator.clipboard.readText();
      if (/^data:image\//i.test(text) || /^https?:/i.test(text)){
        setSceneImages(m => ({ ...m, [sceneId]: text }));
        return true;
      }
      return false;
    }catch{ return false; }
  }
  function startPollingClipboard(){
    stopPollingClipboard();
    try{
      pollRef.current = setInterval(async ()=>{
        const ok = await checkClipboardOnceSilent();
        if (ok){
          setAssistProgress('imported');
          showToast('–ö–∞–¥—Ä –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω');
          stopPollingClipboard();
          setTimeout(()=>setAssistModal(false), 400);
        }
      }, 2000);
    }catch{}
  }
  function stopPollingClipboard(){ if (pollRef.current){ clearInterval(pollRef.current); pollRef.current = null; } }
  async function startAssistantFlow(){
    const ask = buildAssistantAsk(sceneId);
    setAssistantAsk(ask);
    setAssistProgress('ready');
    setAssistModal(true);
    const ok = await safeWriteClipboard(ask); // –í–∞–∂–Ω–æ–µ: –≤—ã–∑–æ–≤ –∏–∑ onClick
    setAssistProgress('copied');
    if (!ok) {
      showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ‚Äî –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
    } else {
      showToast('–ó–∞–ø—Ä–æ—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω ‚Äî –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ —á–∞—Ç');
    }
    startPollingClipboard();
  }

  // --- Image helpers ---
  function setImageFromURL() {
    const url = window.prompt("–í—Å—Ç–∞–≤—å—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (jpg/png/webp)");
    if (!url) return;
    try {
      new URL(url);
      setSceneImages((m) => ({ ...m, [sceneId]: url }));
      showToast("–ö–∞–¥—Ä –ø–æ URL –¥–æ–±–∞–≤–ª–µ–Ω");
    } catch {
      showToast("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL");
    }
  }

  function handleUpload(e) {
    const file = e.target.files?.[0];
    if (!file) return;
    readFileToScene(file);
    e.target.value = "";
  }

  function clearImage() {
    setSceneImages((m) => {
      const n = { ...m };
      delete n[sceneId];
      return n;
    });
    showToast("–ö–∞–¥—Ä –æ—á–∏—â–µ–Ω");
  }

  function placeholderForScene(id) { return generateMockForScene(id, true); }

  function hashCode(str) {
    let h = 0;
    for (let i = 0; i < str.length; i++) { h = (h << 5) - h + str.charCodeAt(i); h |= 0; }
    return h;
  }

  function esc(s){ return String(s||'').replace(/[&<>]/g, function(ch){ return {'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]; }); }

  function generateMockForScene(id, placeholder){
    const s = SCENES[id] || {};
    const title = esc(s.title || '–°—Ü–µ–Ω–∞');
    const subtitle = esc((s.text||'').split('\n')[0]).slice(0,90);
    const hue = Math.abs(hashCode(id)) % 360;
    const bg1 = `hsl(${hue},70%,12%)`;
    const bg2 = `hsl(${(hue+40)%360},80%,18%)`;

    // helpers
    const frame = "<rect x='80' y='160' width='1040' height='360' rx='30' ry='30' fill='rgba(0,0,0,0.22)' stroke='rgba(255,255,255,0.15)'/>";
    const windowRect = (x)=>`<rect x='${x}' y='200' width='220' height='120' rx='14' fill='rgba(255,255,255,0.10)'/>`;
    const seat = (x,y)=>`<rect x='${x}' y='${y}' width='120' height='60' rx='12' fill='rgba(255,255,255,0.12)'/>`;
    const door = (x,y)=>`<rect x='${x}' y='${y}' width='40' height='200' rx='10' fill='rgba(255,255,255,0.10)' stroke='rgba(255,255,255,0.2)'/>`;
    const arrow = (x1,y1,x2,y2)=>`<line x1='${x1}' y1='${y1}' x2='${x2}' y2='${y2}' stroke='white' stroke-width='6' opacity='0.8'/><polygon points='${x2},${y2} ${x2-12},${y2-8} ${x2-12},${y2+8}' fill='white' opacity='0.8'/>`;
    const person = (x,y)=>`<circle cx='${x}' cy='${y}' r='22' fill='white' opacity='0.92'/><line x1='${x}' y1='${y+22}' x2='${x}' y2='${y+80}' stroke='white' stroke-width='6' opacity='0.92'/><line x1='${x}' y1='${y+50}' x2='${x-28}' y2='${y+80}' stroke='white' stroke-width='6' opacity='0.92'/><line x1='${x}' y1='${y+50}' x2='${x+28}' y2='${y+80}' stroke='white' stroke-width='6' opacity='0.92'/>`;
    const caseBox = (x,y,w=90,h=60)=>`<rect x='${x}' y='${y}' width='${w}' height='${h}' rx='10' ry='10' fill='rgba(255,255,255,0.9)'/><rect x='${x+6}' y='${y+6}' width='${w-12}' height='${h-12}' rx='8' ry='8' fill='rgba(0,0,0,0.35)'/>`;

    // base layout variants
    const trainCommon = frame + windowRect(120) + windowRect(360) + windowRect(600) + windowRect(840)
      + seat(140,330) + seat(300,330) + seat(460,330) + seat(620,330) + seat(780,330) + seat(940,330);

    let sketch = '';
    switch(id){
      case 'start':
        sketch = "<rect x='80' y='140' width='380' height='390' rx='18' fill='rgba(0,0,0,0.35)'/>"
               + "<circle cx='270' cy='300' r='70' fill='rgba(255,255,255,0.85)'/>"
               + "<rect x='260' y='220' width='20' height='90' fill='rgba(0,0,0,0.5)'/>";
        break;
      case 'corridor':
      case 'car3_prep':
        sketch = trainCommon + person(220,280) + person(980,280) + arrow(230,280,340,280);
        break;
      case 'tail':
        sketch = trainCommon + person(260,280) + caseBox(420,320) + "<text x='430' y='315' fill='rgba(255,255,255,0.95)' font-size='14'>Li‚Äëion</text>" + arrow(270,280,350,280);
        break;
      case 'bump':
        sketch = trainCommon + person(420,280) + person(520,280) + caseBox(470,330) + "<polygon points='495,255 520,280 495,305 470,280' fill='white' opacity='0.9'/>";
        break;
      case 'bag':
        sketch = "<rect x='220' y='250' width='520' height='220' rx='30' fill='rgba(255,255,255,0.92)'/>" + "<rect x='240' y='270' width='480' height='160' rx='16' fill='rgba(0,0,0,0.45)'/>" + "<rect x='250' y='265' width='460' height='12' rx='6' fill='rgba(255,255,255,0.9)'/>";
        break;
      case 'lining':
        sketch = "<rect x='360' y='270' width='240' height='140' rx='18' fill='rgba(255,255,255,0.95)'/>" + "<rect x='380' y='300' width='80' height='80' rx='10' fill='rgba(255,215,0,0.9)'/>" + "<rect x='480' y='290' width='100' height='100' rx='12' fill='rgba(0,0,0,0.55)'/>" + "<text x='388' y='315' fill='black' font-size='10'>SIM</text>";
        break;
      case 'conductor':
        sketch = trainCommon + "<rect x='150' y='320' width='140' height='70' rx='8' fill='rgba(255,255,255,0.92)'/>" + "<rect x='165' y='335' width='110' height='40' rx='6' fill='rgba(0,0,0,0.35)'/>" + person(980,280);
        break;
      case 'jammer':
        sketch = "<rect x='420' y='240' width='360' height='240' rx='20' fill='rgba(0,0,0,0.45)' stroke='rgba(255,255,255,0.3)'/>" + "<rect x='520' y='280' width='40' height='120' rx='6' fill='rgba(255,255,255,0.95)'/>" + "<circle cx='640' cy='340' r='10' fill='rgba(255,255,255,0.9)'/>";
        break;
      case 'jammer_on':
        sketch = "<rect x='420' y='240' width='360' height='240' rx='20' fill='rgba(0,0,0,0.45)' stroke='rgba(255,255,255,0.3)'/>" + "<rect x='520' y='280' width='40' height='120' rx='6' fill='rgba(120,255,120,0.95)'/>" + "<circle cx='640' cy='340' r='10' fill='rgba(120,255,120,0.95)'/>" + "<circle cx='640' cy='340' r='22' fill='none' stroke='rgba(120,255,120,0.7)' stroke-width='3'/>" + "<circle cx='640' cy='340' r='36' fill='none' stroke='rgba(120,255,120,0.5)' stroke-width='3'/>" + "<text x='620' y='400' fill='rgba(255,255,255,0.9)' font-size='16'>120s</text>";
        break;
      case 'car3_meet':
        sketch = trainCommon + person(420,280) + person(760,280) + caseBox(480,330) + "<rect x='700' y='330' width='36' height='24' fill='rgba(255,255,255,0.92)'/>" + arrow(500,330,680,330) + arrow(740,330,560,330);
        break;
      case 'car3_clear':
        sketch = frame + seat(200,320) + seat(360,320) + seat(520,320) + seat(680,320) + seat(840,320); // –ø—É—Å—Ç–æ–π –≤–∞–≥–æ–Ω
        break;
      case 'lock_try':
        sketch = trainCommon + caseBox(520,320) + "<rect x='585' y='345' width='12' height='12' fill='rgba(255,255,255,0.95)'/>" + "<path d='M590 345 L590 330' stroke='rgba(255,255,255,0.9)' stroke-width='3'/>";
        break;
      case 'call':
        sketch = person(300,260) + "<circle cx='350' cy='260' r='8' fill='rgba(255,255,255,0.95)'/>" + "<path d='M360 260 L430 230' stroke='rgba(255,255,255,0.85)' stroke-width='3'/>" + "<circle cx='440' cy='225' r='4' fill='rgba(255,255,255,0.9)'/>" + "<circle cx='450' cy='220' r='7' fill='none' stroke='rgba(255,255,255,0.7)' stroke-width='2'/>";
        break;
      case 'success':
        sketch = person(420,280) + "<rect x='480' y='330' width='36' height='24' fill='rgba(255,255,255,0.95)'/>" + "<text x='600' y='340' fill='rgba(120,255,120,0.95)' font-size='90' font-weight='800'>‚úì</text>";
        break;
      case 'fail_stop':
        sketch = frame + door(560,200) + "<rect x='570' y='280' width='20' height='60' rx='6' fill='rgba(255,0,0,0.9)'/>" + "<polygon points='600,320 640,300 680,320 660,360 620,360' fill='rgba(255,255,255,0.9)'/>";
        break;
      case 'fail_noise':
      case 'fail_hint':
        sketch = trainCommon + "<polygon points='600,320 640,300 680,320 660,360 620,360' fill='rgba(255,255,255,0.9)'/>";
        break;
      case 'secret':
        sketch = "<rect x='260' y='200' width='680' height='280' rx='40' fill='rgba(255,255,255,0.08)' stroke='rgba(255,255,255,0.3)'/>" + "<circle cx='600' cy='340' r='26' fill='rgba(0,255,0,0.6)'/>" + "<rect x='540' y='230' width='120' height='40' rx='10' fill='rgba(255,255,255,0.15)'/>";
        break;
      default:
        sketch = trainCommon;
    }

    const overlay = genStyle === 'comic'
      ? "<rect x='24' y='24' width='1152' height='627' rx='20' ry='20' fill='rgba(0,0,0,0.12)'/><rect x='44' y='44' width='520' height='240' rx='12' fill='rgba(0,0,0,0.12)'/><rect x='44' y='300' width='520' height='300' rx='12' fill='rgba(0,0,0,0.12)'/><rect x='584' y='44' width='572' height='556' rx='12' fill='rgba(0,0,0,0.12)'/>"
      : genStyle === 'poster'
      ? "<rect x='40' y='40' width='1120' height='595' rx='28' ry='28' fill='rgba(0,0,0,0.18)'/>"
      : '';

    const svg = `
      <svg xmlns='http://www.w3.org/2000/svg' width='1200' height='675'>
        <defs>
          <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
            <stop offset='0%' stop-color='${bg1}'/>
            <stop offset='100%' stop-color='${bg2}'/>
          </linearGradient>
        </defs>
        <rect width='1200' height='675' fill='url(#g)'/>
        ${overlay}
        ${sketch}
        <rect x='40' y='520' width='1120' height='115' fill='rgba(0,0,0,0.42)'/>
        <text x='60' y='560' fill='white' font-family='Inter, system-ui, -apple-system, Segoe UI' font-size='22' font-weight='700'>${title}</text>
        <text x='60' y='590' fill='rgba(255,255,255,0.9)' font-family='Inter, system-ui, -apple-system, Segoe UI' font-size='18'>${subtitle}</text>
        <text x='60' y='640' fill='rgba(255,255,255,0.6)' font-family='Inter, system-ui, -apple-system, Segoe UI' font-size='14'>${placeholder ? '–ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä' : (genStyle==='comic'?'–ö–æ–º–∏–∫—Å‚Äë—Å–∫–µ—Ç—á':'–ê–≤—Ç–æ‚Äë—Å–∫–µ—Ç—á –ø–æ —Å—Ü–µ–Ω–µ')}</text>
      </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }

  function autoGenerateFor(id){
    const src = generateMockForScene(id);
    setSceneImages(m => ({ ...m, [id]: src }));
    showToast('–ú–æ–∫‚Äë–∫–∞–¥—Ä —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω');
  }
  function batchGenerateAll(){ Object.keys(SCENES).forEach(i => { autoGenerateFor(i); }); showToast('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –º–æ–∫‚Äë–∫–∞–¥—Ä—ã –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω'); }
  function downloadCurrentImage(){
    const src = sceneImages[sceneId];
    if (!src) { showToast('–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Å—Ü–µ–Ω—ã'); return; }
    const a = document.createElement('a');
    a.href = src;
    a.download = sceneId + '.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // --- Persistence ---
  React.useEffect(() => {
    try {
      const saved = JSON.parse(localStorage.getItem("ic_mvp_state") || "null");
      if (saved) {
        setLoopSeconds(saved.loopSeconds || DEFAULT_LOOP_SECONDS);
        setTimeLeft(saved.timeLeft ?? (saved.loopSeconds ?? DEFAULT_LOOP_SECONDS));
        setLoopCount(saved.loopCount || 1);
        setSceneId(saved.sceneId || "start");
        setHistory(saved.history || []);
        setClues(saved.clues || []);
        setFastMode(saved.fastMode || false);
        setSceneImages(saved.sceneImages || {});
      }
    } catch {}
  }, []);

  React.useEffect(() => {
    const state = { loopSeconds, timeLeft, loopCount, sceneId, history, clues, fastMode, sceneImages };
    try { localStorage.setItem("ic_mvp_state", JSON.stringify(state)); } catch {}
  }, [loopSeconds, timeLeft, loopCount, sceneId, history, clues, fastMode, sceneImages]);

  // --- Timer ---
  React.useEffect(() => {
    setTimeLeft(loopSeconds);
  }, [loopSeconds, loopCount]);

  React.useEffect(() => {
    const tick = () => setTimeLeft((t) => (t > 0 ? t - 1 : 0));
    const id = setInterval(tick, 1000);
    return () => clearInterval(id);
  }, []);

  React.useEffect(() => {
    if (timeLeft === 0) {
      // Auto restart loop unless we are on an ending scene already
      const ending = SCENES[sceneId]?.ending;
      if (!ending) {
        showToast("–í–∑—Ä—ã–≤. –ü–µ—Ç–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞.");
        setLoopCount((c) => c + 1);
        setSceneId("start");
        setTimeLeft(loopSeconds);
      }
    }
  }, [timeLeft]);

  // Auto-generate a mock frame when entering a scene (if enabled)
  React.useEffect(() => {
    if (autoGen && !sceneImages[sceneId]) { autoGenerateFor(sceneId); }
  }, [sceneId, autoGen]);

  // Stop clipboard polling on unmount
  React.useEffect(() => () => stopPollingClipboard(), []);

  // Focus paste box when modal appears
  React.useEffect(() => {
    if (pasteModal) setTimeout(()=>{ pasteBoxRef.current?.focus(); }, 50);
  }, [pasteModal]);

  // --- Scene transitions ---
  function go(next) {
    if (next === "restart") {
      setLoopCount((c) => c + 1);
      setSceneId("start");
      setTimeLeft(loopSeconds);
      addHistory("–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–µ—Ç–ª–∏");
      return;
    }
    if (next === "export") {
      exportLog();
      addHistory("–≠–∫—Å–ø–æ—Ä—Ç –∂—É—Ä–Ω–∞–ª–∞");
      return;
    }
    if (next === "stay") {
      addHistory("–û—Å—Ç–∞—Ç—å—Å—è –Ω–∞ —Å—Ü–µ–Ω–µ");
      return;
    }
    addHistory(`–í—ã–±–æ—Ä ‚Üí ${next}`);
    setSceneId(next);
    // onEnter hook
    const s = SCENES[next];
    if (s && typeof s.onEnter === "function") {
      try { s.onEnter(); } catch {}
    }
  }

  // Keyboard shortcuts 1/2/3
  React.useEffect(() => {
    const handler = (e) => {
      if (["1", "2", "3"].includes(e.key)) {
        const idx = parseInt(e.key, 10) - 1;
        const ch = (SCENES[sceneId]?.choices || [])[idx];
        if (ch) go(ch.next);
      }
    };
    window.addEventListener("keydown", handler);
    return () => window.removeEventListener("keydown", handler);
  }, [sceneId]);

  const scene = SCENES[sceneId];

  // Progress bar percent
  const pct = Math.max(0, Math.min(100, (timeLeft / loopSeconds) * 100));

  function formatTime(s) {
    const m = Math.floor(s / 60).toString().padStart(2, "0");
    const ss = Math.floor(s % 60).toString().padStart(2, "0");
    return `${m}:${ss}`;
  }

  function QuickPresetButton({ label, seconds }) {
    return (
      <button
        onClick={() => { setLoopSeconds(seconds); setTimeLeft(seconds); showToast(`–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${Math.round(seconds/60)} –º–∏–Ω`); }}
        className="px-3 py-1 rounded-xl border border-white/20 hover:border-white/40 hover:bg-white/5 transition text-xs"
      >{label}</button>
    );
  }

  // --- Minimal inline tests (no env deps) ---
  React.useEffect(() => {
    const results = [];
    const assert = (name, cond) => results.push({ name, ok: !!cond });
    // existing tests (unchanged)
    assert('buildPrompt returns non-empty', !!buildPrompt('start'));
    assert('guessNextFromFree("–ø—Ä–æ—Å–ª–µ–¥–∏—Ç—å") ‚Üí tail', guessNextFromFree('–ø—Ä–æ—Å–ª–µ–¥–∏—Ç—å') === 'tail');
    assert('guessNextFromFree("–≤–∫–ª—é—á–∏—Ç—å –≥–ª—É—à–∏–ª–∫—É") ‚Üí jammer', guessNextFromFree('–≤–∫–ª—é—á–∏—Ç—å –≥–ª—É—à–∏–ª–∫—É') === 'jammer');
    assert('guessNextFromFree("—ç–≤–∞–∫—É–∏—Ä–æ–≤–∞—Ç—å –≤–∞–≥–æ–Ω 3") ‚Üí car3_clear', guessNextFromFree('—ç–≤–∞–∫—É–∏—Ä–æ–≤–∞—Ç—å –≤–∞–≥–æ–Ω 3') === 'car3_clear');
    assert('guessNextFromFree("—Å–µ–∫—Ä–µ—Ç–Ω—ã–π –≤—ã—Ö–æ–¥") ‚Üí secret', guessNextFromFree('—Å–µ–∫—Ä–µ—Ç–Ω—ã–π –≤—ã—Ö–æ–¥') === 'secret');
    // new tests
    assert('guessNextFromFree("—Å—Ç–æ–ø-–∫—Ä–∞–Ω") ‚Üí fail_stop', guessNextFromFree('—Å—Ç–æ–ø-–∫—Ä–∞–Ω') === 'fail_stop');
    assert('guessNextFromFree("–∫—Ä–∞–Ω") ‚Üí fail_stop', guessNextFromFree('–∫—Ä–∞–Ω') === 'fail_stop');
    assert('guessNextFromFree("stop") ‚Üí fail_stop', guessNextFromFree('stop') === 'fail_stop');
    assert('guessNextFromFree("???") defaults to first choice of current scene', guessNextFromFree('???') === (SCENES['start']?.choices?.[0]?.next));
    setTestReport(results);
  }, []);

  const sceneImg = sceneImages[sceneId] || placeholderForScene(sceneId);
  const rawSrc = sceneImages[sceneId];
  const frameLabel = rawSrc ? (rawSrc.startsWith('data:image/svg+xml') ? '–ê–≤—Ç–æ‚Äë–º–æ–∫' : (/^https?:/i.test(rawSrc) ? 'URL' : '–§–∞–π–ª')) : '–ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä';

  return (
    <div className="min-h-screen w-full bg-gradient-to-b from-slate-900 via-slate-950 to-black text-slate-100 p-4">
      {/* Header */}
      <div className="max-w-6xl mx-auto flex flex-col gap-3">
        <header className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="h-10 w-10 rounded-2xl bg-white/10 grid place-items-center">üé¨</div>
            <div>
              <h1 className="text-xl md:text-2xl font-semibold tracking-tight">–ò–ò –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –∫–∏–Ω–æ ‚Äî MVP</h1>
              <p className="text-xs md:text-sm text-slate-300">–¢—Ä–∏ –≤—ã–±–æ—Ä–∞. –û–¥–Ω–∞ –ø–µ—Ç–ª—è. 8 –º–∏–Ω—É—Ç –Ω–∞ —Å–ø–∞—Å–µ–Ω–∏–µ –ø–æ–µ–∑–¥–∞. –ù–∞–∂–∏–º–∞–π 1/2/3 –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ.</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <QuickPresetButton label="8 –º–∏–Ω" seconds={480} />
            <QuickPresetButton label="90 —Å–µ–∫ (–¥–µ–º–æ)" seconds={90} />
            <QuickPresetButton label="30 —Å–µ–∫ (–±—ã—Å—Ç—Ä–æ)" seconds={30} />
            <button onClick={() => { setLoopCount((c)=>c+1); setSceneId("start"); setTimeLeft(loopSeconds); showToast("–ü–µ—Ç–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞"); }} className="px-3 py-1 rounded-xl bg-white/10 hover:bg-white/20 text-xs">–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫</button>
          </div>
        </header>

        {/* Timer Card */}
        <div className="rounded-2xl border border-white/10 bg-white/[0.03] p-4">
          <div className="flex items-center justify-between">
            <div className="text-sm">–ü–µ—Ç–ª—è <span className="font-semibold">#{loopCount}</span></div>
            <div className="text-lg font-mono tabular-nums">{formatTime(timeLeft)}</div>
          </div>
          <div className="h-2 mt-3 w-full rounded-full bg-white/10 overflow-hidden">
            <div className="h-full bg-white/60 transition-all" style={{ width: `${pct}%` }} />
          </div>
        </div>

        {/* Main Grid */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
          {/* Story Panel */}
          <section className="lg:col-span-2 rounded-2xl border border-white/10 bg-white/[0.03] p-5">
            {/* Scene image */}
            <div className="relative aspect-video w-full rounded-xl overflow-hidden border border-white/10 bg-black/40">
              <img src={sceneImg} alt={scene.title} className="w-full h-full object-cover opacity-90" crossOrigin="anonymous" />
              <div className="absolute top-2 left-2 text-[10px] bg-black/50 px-2 py-1 rounded-md border border-white/10">–ò—Å—Ç–æ—á–Ω–∏–∫: {frameLabel}</div>
              <div className="absolute bottom-2 right-2 text-[10px] bg-black/50 px-2 py-1 rounded-md border border-white/10">{scene.title}</div>
            </div>

            {/* New: universal paste/drop zone */}
            <div
              onPaste={handlePasteEvent}
              onDrop={handleDropEvent}
              onDragOver={(e)=>e.preventDefault()}
              className="mt-3 w-full rounded-xl border border-dashed border-white/20 bg-black/20 p-3 text-xs text-slate-300"
              tabIndex={0}
              title="–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ –∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+V –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª"
            >
              –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ PNG/JPG/WebP —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –∏ –Ω–∞–∂–º–∏—Ç–µ <span className="font-medium">Ctrl+V</span> (‚åòV –Ω–∞ Mac) ‚Äî —ç—Ç–æ –æ–±–æ–π–¥—ë—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–∞.
            </div>

            <div className="mt-3 flex flex-wrap items-center gap-2">
              <button onClick={() => fileRef.current?.click()} className="text-xs px-3 py-1 rounded-xl border border-white/20 hover:bg-white/10">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–¥—Ä</button>
              <input ref={fileRef} type="file" accept="image/*" className="hidden" onChange={handleUpload} />
              <button onClick={setImageFromURL} className="text-xs px-3 py-1 rounded-xl border border-white/20 hover:bg-white/10">–í—Å—Ç–∞–≤–∏—Ç—å URL</button>
              <button onClick={() => autoGenerateFor(sceneId)} className="text-xs px-3 py-1 rounded-xl border border-white/20 hover:bg-white/10">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–æ–∫‚Äë–∫–∞–¥—Ä</button>
              <button onClick={batchGenerateAll} className="text-xs px-3 py-1 rounded-xl border border-white/20 hover:bg-white/10">–î–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω</button>
              <button onClick={downloadCurrentImage} className="text-xs px-3 py-1 rounded-xl border border-white/20 hover:bg-white/10">–°–∫–∞—á–∞—Ç—å –∫–∞–¥—Ä</button>
              <button onClick={copyPrompt} className="text-xs px-3 py-1 rounded-xl border border-white/20 hover:bg-white/10">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å SD‚Äë–ø—Ä–æ–º–ø—Ç</button>
              {/* unified assistant flow button (copies request with fallback + starts polling) */}
              <button onClick={startAssistantFlow} className="text-xs px-3 py-1 rounded-xl border border-white/20 hover:bg-white/10">AI‚Äë–≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç)</button>
              <button onClick={pasteImageFromClipboard} className="text-xs px-3 py-1 rounded-xl border border-white/20 hover:bg-white/10">–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞</button>
              <select value={genStyle} onChange={(e)=>setGenStyle(e.target.value)} className="text-xs px-2 py-1 rounded-xl border border-white/20 bg-black/30">
                <option value="storyboard">–°—Ç–∏–ª—å: —Å—Ö–µ–º–∞</option>
                <option value="comic">–°—Ç–∏–ª—å: –∫–æ–º–∏–∫—Å</option>
                <option value="poster">–°—Ç–∏–ª—å: –ø–æ—Å—Ç–µ—Ä</option>
              </select>
              <div className="ml-auto flex items-center gap-2 text-xs">
                <label className="flex items-center gap-1"><input type="checkbox" checked={autoGen} onChange={(e)=>setAutoGen(e.target.checked)} />–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è</label>
              </div>
            </div>

            <div className="flex items-center justify-between gap-2 mt-4">
              <h2 className="text-lg md:text-xl font-semibold tracking-tight">{scene.title}</h2>
            </div>
            <p className="whitespace-pre-wrap mt-3 leading-relaxed text-slate-200">{scene.text}</p>

            {/* Prompt preview */}
            <div className="mt-4 text-xs text-slate-300 select-all break-words bg-black/30 p-3 rounded-xl border border-white/10">
              <div className="mb-1 uppercase tracking-wider text-[10px] text-slate-400">SD‚Äë–ø—Ä–æ–º–ø—Ç</div>
              {scene.prompt}
            </div>

            {/* Choices */}
            <div className="mt-5 grid grid-cols-1 md:grid-cols-3 gap-3">
              {(scene.choices || []).slice(0,3).map((c, idx) => (
                <button
                  key={c.id}
                  onClick={() => go(c.next)}
                  className="group rounded-2xl border border-white/10 bg-gradient-to-b from-white/10 to-white/[0.02] hover:from-white/20 hover:to-white/[0.06] p-4 text-left transition shadow-lg shadow-black/30"
                >
                  <div className="text-[11px] uppercase tracking-widest text-slate-400">–í–∞—Ä–∏–∞–Ω—Ç {idx+1}</div>
                  <div className="mt-1 text-sm md:text-base leading-snug">{c.label}</div>
                  <div className="mt-2 text-[10px] text-slate-400">–ù–∞–∂–º–∏—Ç–µ {idx+1}</div>
                </button>
              ))}
              {/* Ensure 3 buttons visually even if fewer choices */}
              {Array.from({ length: Math.max(0, 3 - (scene.choices?.length || 0)) }).map((_,i) => (
                <div key={"stub"+i} className="rounded-2xl border border-white/5 bg-white/[0.01] p-4 opacity-50 grid place-items-center text-xs">‚Äî</div>
              ))}
            </div>

            {/* Free action input */}
            <div className="mt-3 flex gap-2">
              <input
                value={freeAction}
                onChange={(e)=>setFreeAction(e.target.value)}
                onKeyDown={(e)=>{ if(e.key==='Enter') runFreeAction(); }}
                className="flex-1 px-3 py-2 rounded-xl bg-black/30 border border-white/10 text-sm"
                placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ—ë –¥–µ–π—Å—Ç–≤–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–ø—Ä–æ—Å–ª–µ–¥–∏—Ç—å', '–≤–∫–ª—é—á–∏—Ç—å –≥–ª—É—à–∏–ª–∫—É', '–ø–æ–∑–≤–∞—Ç—å –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–∞')"
              />
              <button onClick={runFreeAction} className="px-3 py-2 rounded-xl border border-white/20 hover:bg-white/10 text-sm">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
            </div>
            <div className="text-[11px] text-slate-400 mt-1">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –∫–æ–º–∞–Ω–¥—ã: "–ø—Ä–æ—Å–ª–µ–¥–∏—Ç—å", "—ç–≤–∞–∫—É–∏—Ä–æ–≤–∞—Ç—å –≤–∞–≥–æ–Ω 3", "–ø–æ–∑–≤–æ–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä—É", "—Å–µ–∫—Ä–µ—Ç–Ω—ã–π –≤—ã—Ö–æ–¥".</div>
          </section>

          {/* Right sidebar */}
          <aside className="rounded-2xl border border-white/10 bg-white/[0.03] p-5">
            <h3 className="text-sm font-semibold">–£–ª–∏–∫–∏</h3>
            <ul className="mt-2 space-y-1 text-sm list-disc list-inside text-slate-200">
              {clues.length ? clues.map((c,i)=>(<li key={i}>{c}</li>)) : <li className="opacity-60">–ü—É—Å—Ç–æ</li>}
            </ul>
            <h3 className="text-sm font-semibold mt-4">–ñ—É—Ä–Ω–∞–ª</h3>
            <div className="mt-2 max-h-56 overflow-auto text-xs leading-relaxed">
              {history.slice().reverse().slice(0,20).map((h,i)=>(
                <div key={i} className="opacity-80"><span className="text-slate-400">[{h.loop}]</span> {h.action}</div>
              ))}
            </div>

            {/* Tests (collapsed) */}
            <details className="mt-4 text-xs opacity-80">
              <summary>Dev‚Äëtests</summary>
              {testReport ? (
                <ul className="mt-2 space-y-1">
                  {testReport.map((r,i)=>(<li key={i} className={r.ok?"text-emerald-300":"text-rose-300"}>{r.ok?"‚úì":"‚úó"} {r.name}</li>))}
                </ul>
              ) : <div>Running‚Ä¶</div>}
            </details>
          </aside>
        </div>

        {/* Toast */}
        {toast && (
          <div className="fixed bottom-4 left-1/2 -translate-x-1/2 bg-white/10 border border-white/20 text-sm px-4 py-2 rounded-xl shadow-xl">{toast}</div>
        )}

        {/* Assistant modal */}
        {assistModal && (
          <div className="fixed inset-0 bg-black/60 backdrop-blur-sm grid place-items-center p-4 z-50">
            <div className="w-full max-w-lg rounded-2xl border border-white/10 bg-slate-900 p-5">
              <div className="text-lg font-semibold">AI‚Äë–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞</div>
              <ol className="mt-3 list-decimal list-inside text-sm space-y-1 text-slate-200">
                <li>–ù–∞–∂–º–∏—Ç–µ ¬´–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å¬ª (–µ—Å–ª–∏ –Ω–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏).</li>
                <li>–í—Å—Ç–∞–≤—å—Ç–µ –∑–∞–ø—Ä–æ—Å —Å—é–¥–∞ –≤ —á–∞—Ç ‚Üí –ø–æ–ª—É—á–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.</li>
                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É (–∏–ª–∏ data‚ÄëURL/—Å—Å—ã–ª–∫—É) ‚Äî —è –ø–æ–¥—Ö–≤–∞—á—É –µ—ë –∏–∑ –±—É—Ñ–µ—Ä–∞ –∏ –¥–æ–±–∞–≤–ª—é –≤ —Å—Ü–µ–Ω—É.</li>
              </ol>
              <textarea
                className="mt-3 w-full h-32 text-[12px] bg-black/30 border border-white/10 rounded-lg p-2"
                readOnly
                value={assistantAsk}
                onFocus={(e)=>e.currentTarget.select()}
              />
              {/* Inline paste/drop area inside modal as well */}
              <div
                ref={pasteBoxRef}
                onPaste={(e)=>{ handlePasteEvent(e); setAssistModal(false); stopPollingClipboard(); }}
                onDrop={(e)=>{ handleDropEvent(e); setAssistModal(false); stopPollingClipboard(); }}
                onDragOver={(e)=>e.preventDefault()}
                tabIndex={0}
                className="mt-3 w-full rounded-xl border border-dashed border-white/20 bg-black/30 p-3 text-xs text-slate-300"
              >–ö–ª–∏–∫–Ω–∏—Ç–µ —Å—é–¥–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ <span className="font-medium">Ctrl+V</span> / –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ PNG ‚Äî –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ä–∞–∑—É –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—Å—è –∫ —Å—Ü–µ–Ω–µ.</div>

              <div className="mt-3 text-xs text-slate-400">–°—Ç–∞—Ç—É—Å: {assistProgress==='copied' ? '–æ–∂–∏–¥–∞–Ω–∏–µ –±—É—Ñ–µ—Ä–∞‚Ä¶' : assistProgress}</div>
              <div className="mt-4 flex gap-2 justify-between">
                <button onClick={async()=>{ const ok = await safeWriteClipboard(assistantAsk); showToast(ok? '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ' : '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Äî –≤—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C'); }} className="px-3 py-2 rounded-xl border border-white/20 hover:bg-white/10 text-sm">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å</button>
                <div className="ml-auto flex gap-2">
                  <button onClick={async()=>{ const ok = await checkClipboardOnceSilent(); if(ok){ setAssistProgress('imported'); showToast('–ö–∞–¥—Ä –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω'); setAssistModal(false); stopPollingClipboard(); } else { setAssistProgress('–Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –±—É—Ñ–µ—Ä–µ'); } }} className="px-3 py-2 rounded-xl border border-white/20 hover:bg-white/10 text-sm">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–π—á–∞—Å</button>
                  <button onClick={()=>{ setAssistModal(false); stopPollingClipboard(); }} className="px-3 py-2 rounded-xl border border-white/20 hover:bg-white/10 text-sm">–û—Ç–º–µ–Ω–∞</button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Manual paste modal when direct clipboard blocked */}
        {pasteModal && (
          <div className="fixed inset-0 bg-black/60 backdrop-blur-sm grid place-items-center p-4 z-50">
            <div className="w-full max-w-md rounded-2xl border border-white/10 bg-slate-900 p-5">
              <div className="text-lg font-semibold">–í—Å—Ç–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ –±—É—Ñ–µ—Ä—É</div>
              <p className="mt-2 text-sm text-slate-300">–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ –æ–±–ª–∞—Å—Ç—å –Ω–∏–∂–µ –∏ –Ω–∞–∂–º–∏—Ç–µ <b>Ctrl+V</b> (–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª). –≠—Ç–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π.</p>
              <div
                ref={pasteBoxRef}
                onPaste={(e)=>{ handlePasteEvent(e); setPasteModal(false); }}
                onDrop={(e)=>{ handleDropEvent(e); setPasteModal(false); }}
                onDragOver={(e)=>e.preventDefault()}
                tabIndex={0}
                className="mt-3 w-full h-28 rounded-xl border border-dashed border-white/20 bg-black/30 p-3 text-xs text-slate-300"
              >–ö–ª–∏–∫–Ω–∏—Ç–µ —Å—é–¥–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+V / –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª‚Ä¶</div>
              <div className="mt-4 flex justify-end gap-2">
                <button onClick={()=>setPasteModal(false)} className="px-3 py-2 rounded-xl border border-white/20 hover:bg-white/10 text-sm">–ó–∞–∫—Ä—ã—Ç—å</button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}


    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<InteractiveCinemaMVP />);
  </script>
</body>
</html>


